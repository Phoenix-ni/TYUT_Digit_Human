<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYUT åˆ›æ–°å­¦ç¤¾æ‹›æ–°åŠ©æ‰‹</title>
    <!-- Add Socket.IO client library -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #10a37f;
            --secondary-color: #1a7f64;
            --success-color: #10a37f;
            --danger-color: #ff375f;
            --warning-color: #ffb300;
            --light-color: #f8f9fa;
            --dark-color: #000000;
            --gray-color: #8e8ea0;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s ease;
            --gradient-start: rgba(16, 163, 127, 0.1);
            --gradient-end: rgba(16, 163, 127, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-color);
            min-height: 100vh;
            padding: 0;
            color: var(--light-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯æ•ˆæœ */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle var(--twinkle-duration, 3s) infinite ease-in-out;
            opacity: 0;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: var(--twinkle-opacity, 0.8);
                transform: scale(1);
            }
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 10px 0;
        }

        h1 {
            color: var(--light-color);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .description {
            color: var(--gray-color);
            font-size: 1rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .digital-human-container {
            width: 75vh;
            height: 80vh;
            max-width: 800px;
            max-height: 80vh;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            margin-top: -20px;
        }

        .response-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 400px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-shadow: var(--box-shadow);
            z-index: 2;
            backdrop-filter: blur(5px);
            border-radius: 0;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .response-container::-webkit-scrollbar {
            width: 8px;
        }

        .response-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .response-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .response-container::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* çŠ¶æ€åŒºåŸŸæ ·å¼ - ç§»åŠ¨åˆ°è¯­éŸ³è¯†åˆ«ç»“æœæ å·¦ä¸Šæ–¹ */
        .status-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 15px;
        }

        .status {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            min-width: 200px;
            font-size: 0.9rem;
        }

        .status::before {
            content: "";
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .recording {
            color: #ffb300;
        }

        .recording::before {
            background-color: #ffb300;
            box-shadow: 0 0 8px #ffb300;
            animation: pulse 1.5s infinite;
        }

        .processing {
            color: var(--success-color);
        }

        .processing::before {
            background-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 163, 127, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 163, 127, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 163, 127, 0);
            }
        }

        /* è¯­éŸ³è¯†åˆ«åŒºåŸŸæ ·å¼ */
        .transcription-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-label {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .transcription-text {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            min-height: 40px;
            color: var(--light-color);
            font-size: 1.1rem;
            line-height: 1.5;
            outline: none;
            transition: var(--transition);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .transcription-text:focus {
            border-color: var(--primary-color);
            background: rgba(16, 163, 127, 0.1);
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
        }

        .edit-hint {
            color: var(--gray-color);
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: right;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .transcription-text:focus + .edit-hint {
            opacity: 1;
        }

        .ai-response-section {
            flex-grow: 1;
        }

        .stay-video, .hear-video, .speak-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* æ°´å°é®ç½©å±‚æ ·å¼ */
        .watermark-cover {
            position: absolute;
            width: 140px;
            height: 90px;
            background-color: rgb(0, 0, 0);
            z-index: 10; /* ç¡®ä¿åœ¨è§†é¢‘å›¾å±‚ä¹‹ä¸Š */
            top: 60px; /* æ ¹æ®éœ€è¦è°ƒæ•´ä½ç½® */
            left: 15px; /* æ ¹æ®éœ€è¦è°ƒæ•´ä½ç½® */
            border-radius: 2px;
            pointer-events: none; /* ç¡®ä¿ä¸ä¼šå¹²æ‰°è§†é¢‘çš„ç‚¹å‡»äº‹ä»¶ */
        }

        .ai-response {
            color: var(--light-color);
            white-space: pre-wrap;
            font-size: 1.2rem;
            line-height: 1.7;
            flex-grow: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .typing-cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: var(--success-color);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .key-hint {
            text-align: center;
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 15px 0;
            color: var(--gray-color);
            font-size: 0.9rem;
            width: 100%;
        }

        .recording-indicator {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 20px;
            height: 20px;
            background-color: var(--danger-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--danger-color);
            animation: pulse 1.5s infinite;
            display: none;
        }

        /* æŠ½å¥–ç›¸å…³æ ·å¼ */
        .lottery-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            margin-top: 10px;
            font-size: 1rem;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .lottery-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff7b3a);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .lottery-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .lottery-content {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-color);
        }

        .lottery-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
            border-radius: 18px 18px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .lottery-header h2 {
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .close-btn {
            font-size: 2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover {
            transform: scale(1.2);
            color: #ffd700;
        }

        .lottery-body {
            padding: 30px;
        }

        .prize-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .prize-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }

        .prize-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .prize-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--light-color);
        }

        .prize-count {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .lottery-wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #ff6b6b 0deg 45deg,
                #4ecdc4 45deg 90deg,
                #45b7d1 90deg 135deg,
                #96ceb4 135deg 180deg,
                #ff6b6b 180deg 225deg,
                #4ecdc4 225deg 270deg,
                #45b7d1 270deg 315deg,
                #96ceb4 315deg 360deg
            );
            position: relative;
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.3, 1);
            box-shadow: 0 0 0 8px rgba(255, 255, 255, 0.1),
                        inset 0 0 0 8px rgba(255, 255, 255, 0.1);
        }

        .wheel-item {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            transform: rotate(22.5deg);
        }

        .wheel-item:nth-child(1) { transform: rotate(22.5deg); }
        .wheel-item:nth-child(2) { transform: rotate(67.5deg); }
        .wheel-item:nth-child(3) { transform: rotate(112.5deg); }
        .wheel-item:nth-child(4) { transform: rotate(157.5deg); }
        .wheel-item:nth-child(5) { transform: rotate(202.5deg); }
        .wheel-item:nth-child(6) { transform: rotate(247.5deg); }
        .wheel-item:nth-child(7) { transform: rotate(292.5deg); }
        .wheel-item:nth-child(8) { transform: rotate(337.5deg); }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd700, #ffa500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transition: var(--transition);
            z-index: 10;
        }

        .wheel-center:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .wheel-center:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .spin-text {
            color: #333;
            font-weight: 700;
            font-size: 1.2rem;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .result-area {
            text-align: center;
            margin-top: 20px;
        }

        .lottery-result {
            font-size: 1.5rem;
            font-weight: 700;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .lottery-result.win {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            animation: pulse 1s infinite;
        }

        .lottery-footer {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            text-align: center;
            border-radius: 0 0 18px 18px;
            color: var(--gray-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .digital-human-container {
                width: 90vw;
                height: 120vw;
                max-height: 70vh;
                margin-top: -20px;
            }
            
            .response-container {
                height: 200px;
                bottom: 20px;
            }
            
            .app-container {
                padding: 10px;
                grid-template-rows: auto 1fr auto;
            }
            
            .transcription-text {
                font-size: 1rem;
                padding: 10px;
            }

            /* æŠ½å¥–å“åº”å¼è®¾è®¡ */
            .lottery-content {
                width: 95%;
                margin: 10px;
            }
            
            .lottery-header h2 {
                font-size: 1.4rem;
            }
            
            .prize-display {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .lottery-wheel-container {
                width: 250px;
                height: 250px;
            }
            
            .wheel-center {
                width: 60px;
                height: 60px;
            }
            
            .spin-text {
                font-size: 1rem;
            }
        }

        /* é’ˆå¯¹è¶…å°å±å¹•çš„é¢å¤–è°ƒæ•´ */
        @media (max-width: 480px) {
            .digital-human-container {
                width: 95vw;
                height: 127vw;
                max-height: 60vh;
                margin-top: -10px;
            }
            
            .response-container {
                height: 180px;
                padding: 15px;
                bottom: 10px;
            }
            
            .ai-response {
                font-size: 1rem;
            }
            
            .transcription-section {
                margin-bottom: 15px;
            }
            
            .status {
                min-width: 150px;
                font-size: 0.8rem;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- æ˜Ÿæ˜ŸèƒŒæ™¯ -->
    <div class="stars" id="stars"></div>
    
    <div class="app-container">
        <div class="header">
            <h1>TYUT åˆ›æ–°å­¦ç¤¾æ‹›æ–°åŠ©æ‰‹</h1>
            <p class="description">è¯­éŸ³é©±åŠ¨AIå¯¹è¯ - æŒ‰ä½ç©ºæ ¼é”®è¯´è¯</p>
            <button id="lotteryButton" class="lottery-btn">ğŸ å‚ä¸æ‹›æ–°æŠ½å¥–</button>
            <button id="manualInputBtn" class="lottery-btn" style="margin-left: 10px;">ğŸ“ æ‰‹åŠ¨è¾“å…¥</button>
        </div>
        
        <div class="main-content">
            <div class="digital-human-container" id="digitalHumanContainer">
                <!-- é¢„åŠ è½½æ‰€æœ‰stayè§†é¢‘ -->
                <video id="stayVideo1" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay1.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo2" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay2.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo3" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay3.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo4" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay4.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo5" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay5.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo6" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay6.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo7" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay7.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo8" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay8.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo9" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay9.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo10" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay10.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo11" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay11.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo12" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay12.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo13" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay13.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo14" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay14.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo15" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay15.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo16" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay16.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo17" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay17.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="stayVideo18" class="stay-video" style="display: none;" playsinline muted>
                    <source src="/static/2D_Live/stay18.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>

                <video id="hearVideo" class="hear-video" style="display: none;" loop playsinline muted>
                    <source src="/static/2D_Live/hear.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <video id="speakVideo" class="speak-video" style="display: none;" loop playsinline muted>
                    <source src="/static/2D_Live/speak.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                
                <!-- æ°´å°é®ç½©å±‚ -->
                <div id="watermarkCover" class="watermark-cover"></div>
            </div>
        </div>
        
        <div class="key-hint">
            æç¤º: æŒ‰ä½ç©ºæ ¼é”®å¼€å§‹å½•éŸ³ï¼Œæ¾å¼€åœæ­¢
        </div>
        
        <!-- å“åº”å®¹å™¨ -->
        <div class="response-container">
            <!-- çŠ¶æ€æç¤ºåŒºåŸŸ - ç§»åŠ¨åˆ°è¯­éŸ³è¯†åˆ«ç»“æœæ å·¦ä¸Šæ–¹ -->
            <div class="status-container">
                <div id="status" class="status">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>
            </div>
            
            <!-- è¯­éŸ³è¯†åˆ«ç»“æœæ˜¾ç¤ºå’Œç¼–è¾‘åŒºåŸŸ -->
            <div class="transcription-section">
                <div class="section-label">è¯­éŸ³è¯†åˆ«ç»“æœ:</div>
                <div id="transcriptionText" class="transcription-text" contenteditable="true"></div>
                <div class="edit-hint">æŒ‰ Enter ç¡®è®¤ä¿®æ”¹ï¼ŒæŒ‰ Esc å–æ¶ˆ</div>
            </div>
            
            <div class="ai-response-section">
                <div class="section-label">AIå›å¤:</div>
                <div id="aiResponse" class="ai-response"></div>
                <span id="typingCursor" class="typing-cursor" style="display: none;"></span>
            </div>
        </div>
    </div>

    <!-- æŠ½å¥–æ¨¡æ€æ¡† -->
    <div id="lotteryModal" class="lottery-modal" style="display: none;">
        <div class="lottery-content">
            <div class="lottery-header">
                <h2>ğŸ TYUT åˆ›æ–°å­¦ç¤¾ æ‹›æ–°æŠ½å¥– ğŸ</h2>
                <span class="close-btn" id="closeLottery">&times;</span>
            </div>
            
            <div class="lottery-body">
                <div class="prize-display" id="prizeDisplay">
                    <div class="prize-item" data-prize="keychain">
                        <div class="prize-icon">ğŸ”‘</div>
                        <div class="prize-name">å®šåˆ¶é’¥åŒ™æ‰£</div>
                        <div class="prize-count" id="keychainCount">98</div>
                    </div>
                    <div class="prize-item" data-prize="mousepad">
                        <div class="prize-icon">ğŸ–±ï¸</div>
                        <div class="prize-name">ç²¾ç¾é¼ æ ‡å«</div>
                        <div class="prize-count" id="mousepadCount">46</div>
                    </div>
                    <div class="prize-item" data-prize="cup">
                        <div class="prize-icon">ğŸ†</div>
                        <div class="prize-name">é™é‡æ°´æ¯</div>
                        <div class="prize-count" id="cupCount">1</div>
                    </div>
                    <div class="prize-item" data-prize="candy">
                        <div class="prize-icon">ğŸ¬</div>
                        <div class="prize-name">é¥¼å¹²ç³–æœ</div>
                        <div class="prize-count">ä¸é™é‡</div>
                    </div>
                </div>
                
                <div class="lottery-wheel-container">
                    <div class="wheel" id="lotteryWheel">
                        <div class="wheel-item" data-prize="keychain">é’¥åŒ™æ‰£</div>
                        <div class="wheel-item" data-prize="mousepad">é¼ æ ‡å«</div>
                        <div class="wheel-item" data-prize="cup">æ°´æ¯</div>
                        <div class="wheel-item" data-prize="candy">ç³–æœ</div>
                        <div class="wheel-item" data-prize="keychain">é’¥åŒ™æ‰£</div>
                        <div class="wheel-item" data-prize="mousepad">é¼ æ ‡å«</div>
                        <div class="wheel-item" data-prize="candy">ç³–æœ</div>
                        <div class="wheel-item" data-prize="keychain">é’¥åŒ™æ‰£</div>
                    </div>
                    <div class="wheel-center" id="spinButton">
                        <div class="spin-text">æŠ½å¥–</div>
                    </div>
                </div>
                
                <div class="result-area">
                    <div id="lotteryResult" class="lottery-result"></div>
                    <button id="confirmResult" class="lottery-btn" style="display: none;">ç¡®è®¤é¢†å–</button>
                </div>
            </div>
            
            <div class="lottery-footer">
                <p>æ¬¢è¿å‚ä¸æ‹›æ–°æŠ½å¥–ï¼Œç¥ä½ å¥½è¿ï¼</p>
            </div>
        </div>
    </div>

    <script>
        // åˆ›å»ºæ˜Ÿæ˜ŸèƒŒæ™¯
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 100; // æ˜Ÿæ˜Ÿæ•°é‡
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // éšæœºä½ç½®
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                
                // éšæœºå¤§å° (1-3px)
                const size = Math.random() * 4 + 1;
                
                // éšæœºé—ªçƒæŒç»­æ—¶é—´ (2-5ç§’)
                const duration = Math.random() * 3 + 2;
                
                // éšæœºé—ªçƒå»¶è¿Ÿ (0-5ç§’)
                const delay = Math.random() * 5;
                
                // éšæœºé—ªçƒå¼ºåº¦ (0.3-0.9)
                const opacity = Math.random() * 0.6 + 0.3;
                
                star.style.left = `${left}%`;
                star.style.top = `${top}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--twinkle-duration', `${duration}s`);
                star.style.setProperty('--twinkle-opacity', opacity);
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
            }
        }

        // è½¬å½•æ–‡æœ¬åŒºåŸŸçš„ç„¦ç‚¹è®¾ç½®
        function setupTranscriptionFocus() {
            setTimeout(() => {
                transcriptionText.focus();
                placeCaretAtEnd(transcriptionText);
                // æ·»åŠ è¾¹æ¡†é«˜äº®æç¤º
                transcriptionText.style.border = '2px solid var(--primary-color)';
                transcriptionText.style.background = 'rgba(16, 163, 127, 0.1)';
                
                // 3ç§’åæ¢å¤æ™®é€šæ ·å¼
                setTimeout(() => {
                    transcriptionText.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                    transcriptionText.style.background = 'rgba(255, 255, 255, 0.1)';
                }, 3000);
            }, 300);
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†å…‰æ ‡ç½®äºæ–‡æœ¬æœ«å°¾
        function placeCaretAtEnd(element) {
            element.focus();
            if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
                const range = document.createRange();
                range.selectNodeContents(element);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // åˆ›å»ºæ˜Ÿæ˜ŸèƒŒæ™¯
            createStars();
            
            // è·å–å…ƒç´ 
            const digitalHumanContainer = document.getElementById('digitalHumanContainer');
            const stayVideos = [
                document.getElementById('stayVideo1'),
                document.getElementById('stayVideo2'),
                document.getElementById('stayVideo3'),
                document.getElementById('stayVideo4'),
                document.getElementById('stayVideo5'),
                document.getElementById('stayVideo6'),
                document.getElementById('stayVideo7'),
                document.getElementById('stayVideo8'),
                document.getElementById('stayVideo9'),
                document.getElementById('stayVideo10'),
                document.getElementById('stayVideo11'),
                document.getElementById('stayVideo12'),
                document.getElementById('stayVideo13'),
                document.getElementById('stayVideo14'),
                document.getElementById('stayVideo15'),
                document.getElementById('stayVideo16'),
                document.getElementById('stayVideo17'),
                document.getElementById('stayVideo18')
            ];
            const hearVideo = document.getElementById('hearVideo');
            const speakVideo = document.getElementById('speakVideo');
            const statusDiv = document.getElementById('status');
            const aiResponse = document.getElementById('aiResponse');
            const typingCursor = document.getElementById('typingCursor');
            
            // è·å–æ–°å¢çš„å…ƒç´ 
            const transcriptionText = document.getElementById('transcriptionText');
            const manualInputBtn = document.getElementById('manualInputBtn');
            
            let currentStayVideoIndex = -1;
            
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let audioContext;
            let audioSource;
            let scriptProcessor;
            let socket;
            let isAIResponding = false;
            let shouldAbortResponse = false;
            
            // æ–°å¢ï¼šæ–‡æœ¬ç¼“å†²åŒºå’Œå®šæ—¶å™¨
            let textBuffer = "";
            let textOutputTimer = null;
            const CHAR_DELAY = 30; // æ¯ä¸ªå­—ç¬¦è¾“å‡ºçš„å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
            let isTextOutputComplete = true; // æ–°å¢ï¼šè·Ÿè¸ªæ–‡æœ¬è¾“å‡ºæ˜¯å¦å®Œæˆ
            let lastFullResponse = ""; // å­˜å‚¨å®Œæ•´çš„å“åº”æ–‡æœ¬ç”¨äºé‡æ–°æ’­æ”¾
            
            // å­˜å‚¨è½¬å½•æ–‡æœ¬å’Œç¼–è¾‘çŠ¶æ€
            let currentTranscription = "";
            let isEditingTranscription = false;
            let originalTranscription = "";

            // æ–°å¢ï¼šTTSçŠ¶æ€è·Ÿè¸ª
            let isTTSPlaying = false;
            let isTTSFailed = false;

            // ä¿®æ”¹ï¼šæ’­æ”¾éšæœºstayè§†é¢‘ - ä¼˜åŒ–ç‰ˆæœ¬
            function playRandomStayVideo() {
                // éšè—æ‰€æœ‰stayè§†é¢‘
                stayVideos.forEach(video => {
                    video.style.display = 'none';
                    video.pause();
                });
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªè§†é¢‘ç¼–å·ï¼ˆæ’é™¤å½“å‰æ­£åœ¨æ’­æ”¾çš„ï¼‰
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * stayVideos.length);
                } while (randomIndex === currentStayVideoIndex && stayVideos.length > 1);
                
                currentStayVideoIndex = randomIndex;
                const selectedVideo = stayVideos[currentStayVideoIndex];
                
                // æ˜¾ç¤ºå¹¶æ’­æ”¾é€‰ä¸­çš„è§†é¢‘
                selectedVideo.style.display = 'block';
                selectedVideo.play().catch(err => {
                    console.error(`Stayè§†é¢‘æ’­æ”¾å¤±è´¥:`, err);
                    // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´åé‡è¯•
                    setTimeout(playRandomStayVideo, 1000);
                });
            }

            // ä¿®æ”¹ï¼šåˆå§‹åŒ–stayè§†é¢‘ - ä¼˜åŒ–ç‰ˆæœ¬
            function initStayVideo() {
                // ä¸ºæ¯ä¸ªstayè§†é¢‘è®¾ç½®ç»“æŸäº‹ä»¶
                stayVideos.forEach(video => {
                    video.addEventListener('ended', function() {
                        console.log('è§†é¢‘æ’­æ”¾ç»“æŸï¼Œå‡†å¤‡æ’­æ”¾ä¸‹ä¸€ä¸ªéšæœºè§†é¢‘');
                        playRandomStayVideo();
                    });
                });
                
                // å¼€å§‹æ’­æ”¾ç¬¬ä¸€ä¸ªéšæœºè§†é¢‘
                playRandomStayVideo();
            }

            // æ˜¾ç¤ºå¬éŸ³åŠ¨ç”»
            function showHearingAnimation() {
                // éšè—æ‰€æœ‰stayè§†é¢‘
                stayVideos.forEach(video => {
                    video.style.display = 'none';
                    video.pause();
                });
                
                speakVideo.style.display = 'none';
                speakVideo.pause();
                speakVideo.currentTime = 0;
                hearVideo.style.display = 'block';
                hearVideo.play().catch(err => {
                    console.error("å¬éŸ³è§†é¢‘æ’­æ”¾å¤±è´¥:", err);
                });
            }

            // æ˜¾ç¤ºè¯´è¯åŠ¨ç”»
            function showSpeakingAnimation() {
                // éšè—æ‰€æœ‰stayè§†é¢‘
                stayVideos.forEach(video => {
                    video.style.display = 'none';
                    video.pause();
                });
                
                hearVideo.style.display = 'none';
                hearVideo.pause();
                hearVideo.currentTime = 0;
                speakVideo.style.display = 'block';
                speakVideo.play().catch(err => {
                    console.error("è¯´è¯è§†é¢‘æ’­æ”¾å¤±è´¥:", err);
                });
            }

            // æ˜¾ç¤ºé™æ¯çŠ¶æ€ï¼ˆéšæœºstayè§†é¢‘ï¼‰
            function showStayVideo() {
                hearVideo.style.display = 'none';
                hearVideo.pause();
                hearVideo.currentTime = 0;
                speakVideo.style.display = 'none';
                speakVideo.pause();
                speakVideo.currentTime = 0;
                
                // æ˜¾ç¤ºå½“å‰stayè§†é¢‘
                if (currentStayVideoIndex >= 0 && currentStayVideoIndex < stayVideos.length) {
                    const currentVideo = stayVideos[currentStayVideoIndex];
                    currentVideo.style.display = 'block';
                    
                    // å¦‚æœå½“å‰è§†é¢‘æ²¡æœ‰åœ¨æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹æ’­æ”¾
                    if (currentVideo.paused) {
                        currentVideo.play().catch(err => {
                            console.error("Stayè§†é¢‘æ’­æ”¾å¤±è´¥:", err);
                        });
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰å½“å‰è§†é¢‘ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
                    playRandomStayVideo();
                }
            }
            
            // æ–°å¢ï¼šé€å­—è¾“å‡ºå‡½æ•°
            function outputTextCharacter() {
                if (textBuffer.length > 0) {
                    // è¾“å‡ºä¸€ä¸ªå­—ç¬¦
                    aiResponse.textContent += textBuffer.charAt(0);
                    textBuffer = textBuffer.substring(1);
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    aiResponse.scrollTop = aiResponse.scrollHeight;
                    
                    // ç»§ç»­è¾“å‡ºä¸‹ä¸€ä¸ªå­—ç¬¦
                    textOutputTimer = setTimeout(outputTextCharacter, CHAR_DELAY);
                } else {
                    // æ–‡æœ¬è¾“å‡ºå®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
                    clearTimeout(textOutputTimer);
                    textOutputTimer = null;
                    isTextOutputComplete = true; // æ ‡è®°æ–‡æœ¬è¾“å‡ºå®Œæˆ
                    
                    // åœæ­¢AIå“åº”æ•ˆæœï¼ˆå…‰æ ‡é—ªçƒï¼‰
                    stopAIResponseEffect();
                    
                    // å¦‚æœTTSæ’­æ”¾å¤±è´¥æˆ–æ²¡æœ‰TTSæ’­æ”¾ï¼Œç«‹å³æ˜¾ç¤ºé™æ¯çŠ¶æ€
                    if (isTTSFailed || !isTTSPlaying) {
                        showStayVideo();
                    }
                    // å¦‚æœTTSæ­£åœ¨æ’­æ”¾ï¼Œç­‰å¾…TTSå®Œæˆäº‹ä»¶æ¥æ˜¾ç¤ºé™æ¯çŠ¶æ€
                }
            }
            
            // æ–°å¢ï¼šæ·»åŠ æ–‡æœ¬åˆ°ç¼“å†²åŒº
            function appendToBuffer(text) {
                textBuffer += text;
                
                // å¦‚æœæ²¡æœ‰æ­£åœ¨è¾“å‡ºçš„å®šæ—¶å™¨ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ª
                if (!textOutputTimer) {
                    isTextOutputComplete = false; // æ ‡è®°æ–‡æœ¬è¾“å‡ºå¼€å§‹
                    showSpeakingAnimation(); // æ˜¾ç¤ºè¯´è¯åŠ¨ç”» - åªåœ¨å¼€å§‹è¾“å‡ºæ–‡å­—æ—¶æ˜¾ç¤º
                    outputTextCharacter();
                }
            }
            
            // æ–°å¢ï¼šæ¸…ç©ºæ–‡æœ¬ç¼“å†²åŒº
            function clearTextBuffer() {
                textBuffer = "";
                if (textOutputTimer) {
                    clearTimeout(textOutputTimer);
                    textOutputTimer = null;
                }
                isTextOutputComplete = true; // æ ‡è®°æ–‡æœ¬è¾“å‡ºå®Œæˆ
            }
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå½•éŸ³
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨å¦‚Chromeã€Firefoxç­‰ã€‚');
            }
            
            // å¼€å§‹å½•éŸ³
            function startRecording() {
                if (isRecording) return;
                
                // å¦‚æœæœ‰AIæ­£åœ¨å“åº”ï¼Œè®¾ç½®ä¸­æ–­æ ‡å¿—
                if (isAIResponding) {
                    shouldAbortResponse = true;
                    if (socket && socket.connected) {
                        socket.emit('abort_response');
                    }
                    // æ¸…ç©ºå½“å‰å“åº”
                    aiResponse.textContent = '';
                    clearTextBuffer(); // æ¸…ç©ºæ–‡æœ¬ç¼“å†²åŒº
                    stopAIResponseEffect();
                    showStayVideo();
                }
                
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        startRealtimeRecording(stream);
                        
                        isRecording = true;
                        statusDiv.textContent = 'ğŸ¤ å½•éŸ³ä¸­...';
                        statusDiv.className = 'status recording';
                        aiResponse.textContent = '';
                        clearTextBuffer(); // æ¸…ç©ºæ–‡æœ¬ç¼“å†²åŒº
                        
                        // æ¸…ç©ºè½¬å½•æ–‡æœ¬
                        transcriptionText.textContent = '';
                        
                        // æ˜¾ç¤ºå¬éŸ³åŠ¨ç”»
                        showHearingAnimation();
                        
                    })
                    .catch(error => {
                        console.error('è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
                        statusDiv.textContent = 'âŒ æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                        statusDiv.className = 'status';
                    });
            }
            
            // åœæ­¢å½•éŸ³
            function stopRecording() {
                if (!isRecording) return;
                
                stopRealtimeRecording();
                
                isRecording = false;
                statusDiv.textContent = 'ğŸ”„ å¤„ç†ä¸­...';
                statusDiv.className = 'status processing';
                
                // åœæ­¢å¬éŸ³åŠ¨ç”»ï¼Œæ˜¾ç¤ºé™æ¯çŠ¶æ€
                showStayVideo();
            }
            
            // å®æ—¶æµå¼ä¼ è¾“æ–¹å¼ - å¼€å§‹å½•éŸ³
            function startRealtimeRecording(stream) {
                // åˆå§‹åŒ–Socket.IOè¿æ¥
                socket = io('http://localhost:5000', {
                    transports: ['websocket']
                });
                
                socket.on('connect', () => {
                    console.log('Socket.IOè¿æ¥å·²å»ºç«‹');
                    // å‘æœåŠ¡å™¨å‘é€å¼€å§‹å½•éŸ³äº‹ä»¶å’Œé€‰æ‹©çš„æ¨¡å‹
                    socket.emit('start_recording', {
                        model: 'LongCat-Flash-Chat' // ä½¿ç”¨é»˜è®¤æ¨¡å‹
                    });
                });
                
                socket.on('recording_started', (data) => {
                    statusDiv.textContent = 'ğŸ¤ å½•éŸ³ä¸­ï¼ˆå®æ—¶æ¨¡å¼ï¼‰...';
                });
                
                socket.on('transcription_result', (data) => {
                    if (data.error) {
                        statusDiv.textContent = `é”™è¯¯: ${data.error}`;
                        statusDiv.className = 'status';
                        transcriptionText.textContent = "è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•";
                    } else {
                        statusDiv.textContent = 'âœ… è½¬å½•å®Œæˆï¼Œå¯ç¼–è¾‘æ–‡æœ¬';
                        statusDiv.className = 'status';
                        
                        // æ˜¾ç¤ºè½¬å½•æ–‡æœ¬
                        currentTranscription = data.text;
                        transcriptionText.textContent = currentTranscription;
                        originalTranscription = currentTranscription;
                        
                        // è®¾ç½®ç„¦ç‚¹å’Œæ ·å¼æç¤º
                        setupTranscriptionFocus();
                    }
                });
                
                // æ–°å¢ï¼šç”¨æˆ·ç¡®è®¤æ–‡æœ¬äº‹ä»¶å¤„ç†
                socket.on('user_confirmed_text_ack', (data) => {
                    statusDiv.textContent = 'ğŸ”„ æ­£åœ¨ç”ŸæˆAIå›å¤...';
                    statusDiv.className = 'status processing';
                    // é‡ç½®TTSçŠ¶æ€
                    isTTSPlaying = false;
                    isTTSFailed = false;
                    // ä¿æŒé™æ¯çŠ¶æ€ï¼Œç­‰å¾…æ–‡å­—è¾“å‡º
                    showStayVideo();
                });
                
                socket.on('ai_response_start', (data) => {
                    startAIResponseEffect();
                    aiResponse.textContent = ''; // æ¸…ç©ºä¹‹å‰çš„å“åº”
                    clearTextBuffer(); // æ¸…ç©ºæ–‡æœ¬ç¼“å†²åŒº
                    lastFullResponse = ""; // é‡ç½®å®Œæ•´å“åº”
                    // é‡ç½®TTSçŠ¶æ€
                    isTTSPlaying = false;
                    isTTSFailed = false;
                    // ä¿æŒé™æ¯çŠ¶æ€ï¼Œç­‰å¾…æ–‡å­—è¾“å‡º
                    showStayVideo();
                });
                
                // ä¿®æ”¹è¿™é‡Œï¼šä¸å†ä½¿ç”¨æµå¼è¾“å‡ºï¼Œè€Œæ˜¯ç­‰å¾…å®Œæ•´æ–‡æœ¬
                socket.on('ai_response_complete', (data) => {
                    // è¿™é‡Œæˆ‘ä»¬æ”¶åˆ°å®Œæ•´çš„å“åº”æ–‡æœ¬ï¼Œå¼€å§‹é€å­—æ˜¾ç¤º
                    if (data.full_text) {
                        lastFullResponse = data.full_text;
                        // å¼€å§‹é€å­—æ˜¾ç¤ºæ–‡æœ¬
                        appendToBuffer(data.full_text);
                    }
                    // æ³¨æ„ï¼šè¿™é‡Œä¸åœæ­¢å“åº”æ•ˆæœï¼Œå› ä¸ºæ–‡æœ¬è¾“å‡ºå¯èƒ½è¿˜åœ¨è¿›è¡Œ
                    statusDiv.textContent = 'âœ… å›ç­”å®Œæˆ';
                    statusDiv.className = 'status';
                });
                
                // TTSç›¸å…³äº‹ä»¶
                socket.on('tts_generating', (data) => {
                    // å½“å¼€å§‹ç”Ÿæˆè¯­éŸ³æ—¶ï¼Œä¿æŒé™æ¯çŠ¶æ€
                    // è¯´è¯åŠ¨ç”»ä¼šåœ¨æ–‡å­—è¾“å‡ºæ—¶è‡ªåŠ¨æ˜¾ç¤º
                    isTTSPlaying = true;
                    isTTSFailed = false;
                    showStayVideo();
                });
                
                socket.on('tts_playing', (data) => {
                    // å½“å¼€å§‹æ’­æ”¾è¯­éŸ³æ—¶ï¼Œæ˜¾ç¤ºè¯´è¯åŠ¨ç”»
                    // ä½†åªæœ‰åœ¨æœ‰æ–‡å­—è¾“å‡ºæ—¶æ‰æ˜¾ç¤ºï¼Œå¦åˆ™ä¿æŒé™æ¯çŠ¶æ€
                    isTTSPlaying = true;
                    isTTSFailed = false;
                    if (!isTextOutputComplete) {
                        showSpeakingAnimation();
                    }
                });
                
                socket.on('tts_complete', (data) => {
                    // TTSæ’­æ”¾å®Œæˆ
                    isTTSPlaying = false;
                    // åªæœ‰å½“æ–‡æœ¬è¾“å‡ºä¹Ÿå®Œæˆæ—¶æ‰æ˜¾ç¤ºé™æ¯çŠ¶æ€
                    if (isTextOutputComplete) {
                        showStayVideo();
                    }
                });
                
                socket.on('tts_error', (data) => {
                    // TTSå‡ºé”™æ—¶
                    isTTSPlaying = false;
                    isTTSFailed = true;
                    // å¦‚æœæ–‡æœ¬è¾“å‡ºå®Œæˆäº†ï¼Œæ˜¾ç¤ºé™æ¯çŠ¶æ€
                    if (isTextOutputComplete) {
                        showStayVideo();
                    }
                });
                
                socket.on('error', (data) => {
                    console.error('Socket.IOé”™è¯¯:', data.message);
                    statusDiv.textContent = `âŒ ${data.message}`;
                    statusDiv.className = 'status';
                    stopAIResponseEffect();
                    showStayVideo(); // æ˜¾ç¤ºé™æ¯çŠ¶æ€
                });
                
                socket.on('disconnect', () => {
                    console.log('Socket.IOè¿æ¥å·²å…³é—­');
                    stopAIResponseEffect();
                    showStayVideo(); // æ˜¾ç¤ºé™æ¯çŠ¶æ€
                });
                
                socket.on('response_aborted', () => {
                    console.log('å“åº”å·²ä¸­æ­¢');
                    stopAIResponseEffect();
                    showStayVideo();
                    clearTextBuffer(); // æ¸…ç©ºæ–‡æœ¬ç¼“å†²åŒº
                    shouldAbortResponse = false;
                    statusDiv.textContent = 'â¹ï¸ å“åº”å·²ä¸­æ­¢';
                    statusDiv.className = 'status';
                });
                
                // è®¾ç½®éŸ³é¢‘å¤„ç†ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000 // è®¾ç½®é‡‡æ ·ç‡ä¸åç«¯ä¸€è‡´
                });
                
                audioSource = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(1024, 1, 1);
                
                audioSource.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                // å¤„ç†éŸ³é¢‘æ•°æ®
                scriptProcessor.onaudioprocess = (event) => {
                    if (socket && socket.connected && isRecording) {
                        const inputBuffer = event.inputBuffer;
                        const channelData = inputBuffer.getChannelData(0);
                        
                        // å°†Float32Arrayè½¬æ¢ä¸ºå¯ä»¥ä¼ è¾“çš„æ ¼å¼
                        const floatArray = new Float32Array(channelData.length);
                        floatArray.set(channelData);
                        
                        // ä½¿ç”¨ArrayBufferå‘é€äºŒè¿›åˆ¶æ•°æ®
                        socket.emit('audio_data', {
                            chunk: Array.from(floatArray.slice(0, 1024)) // å‘é€å‰1024ä¸ªæ ·æœ¬
                        });
                    }
                };
            }
            
            // å®æ—¶æµå¼ä¼ è¾“æ–¹å¼ - åœæ­¢å½•éŸ³
            function stopRealtimeRecording() {
                if (socket && socket.connected) {
                    socket.emit('stop_recording');
                }
                
                if (audioContext) {
                    audioContext.close();
                }
            }
            
            // å¯åŠ¨AIå“åº”æ•ˆæœ
            function startAIResponseEffect() {
                isAIResponding = true;
                typingCursor.style.display = 'inline-block';
            }
            
            // åœæ­¢AIå“åº”æ•ˆæœ
            function stopAIResponseEffect() {
                isAIResponding = false;
                typingCursor.style.display = 'none';
            }
            
            // ç›‘å¬è½¬å½•æ–‡æœ¬åŒºåŸŸçš„é”®ç›˜äº‹ä»¶
            transcriptionText.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    
                    const editedText = transcriptionText.textContent.trim();
                    if (!editedText) {
                        statusDiv.textContent = 'âŒ æ–‡æœ¬ä¸èƒ½ä¸ºç©º';
                        statusDiv.className = 'status';
                        return;
                    }
                    
                    currentTranscription = editedText;
                    statusDiv.textContent = 'ğŸ”„ æ­£åœ¨ç”ŸæˆAIå›å¤...';
                    statusDiv.className = 'status processing';
                    
                    // å‘é€ç¼–è¾‘åçš„æ–‡æœ¬åˆ°åç«¯
                    if (socket && socket.connected) {
                        socket.emit('user_confirmed_text', {
                            text: editedText,
                            model: 'LongCat-Flash-Chat' // ä½¿ç”¨å›ºå®šæ¨¡å‹
                        });
                    } else {
                        statusDiv.textContent = 'âŒ è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢';
                        statusDiv.className = 'status';
                    }
                    
                    // ç§»é™¤ç„¦ç‚¹
                    transcriptionText.blur();
                    
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    
                    // å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
                    transcriptionText.textContent = originalTranscription;
                    transcriptionText.blur();
                    
                    statusDiv.textContent = 'ç¼–è¾‘å·²å–æ¶ˆ';
                    setTimeout(() => {
                        statusDiv.textContent = 'âœ… è½¬å½•å®Œæˆï¼Œå¯ç¼–è¾‘æ–‡æœ¬';
                    }, 2000);
                }
            });
            
            // ç›‘å¬ç„¦ç‚¹äº‹ä»¶
            transcriptionText.addEventListener('focus', function() {
                isEditingTranscription = true;
                this.style.background = 'rgba(16, 163, 127, 0.15)';
            });
            
            transcriptionText.addEventListener('blur', function() {
                isEditingTranscription = false;
                this.style.background = 'rgba(255, 255, 255, 0.1)';
            });
            
            // æ‰‹åŠ¨è¾“å…¥æŒ‰é’®äº‹ä»¶
            manualInputBtn.addEventListener('click', function() {
                const userText = prompt('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜:');
                if (userText && userText.trim()) {
                    statusDiv.textContent = 'ğŸ”„ æ­£åœ¨ç”ŸæˆAIå›å¤...';
                    statusDiv.className = 'status processing';
                    
                    if (socket && socket.connected) {
                        socket.emit('user_confirmed_text', {
                            text: userText.trim(),
                            model: 'LongCat-Flash-Chat'
                        });
                    } else {
                        alert('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                }
            });
            
            // ç©ºæ ¼é”®äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', function(event) {
                if (event.code === 'Space' && !isRecording && !event.repeat) {
                    event.preventDefault(); // é˜²æ­¢ç©ºæ ¼é”®æ»šåŠ¨é¡µé¢
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘è½¬å½•æ–‡æœ¬ï¼Œå…ˆä¿å­˜ç¼–è¾‘
                    if (isEditingTranscription) {
                        transcriptionText.blur();
                    }
                    startRecording();
                }
            });
            
            document.addEventListener('keyup', function(event) {
                if (event.code === 'Space' && isRecording) {
                    event.preventDefault();
                    stopRecording();
                }
            });
            
            // é˜²æ­¢ç©ºæ ¼é”®æ»šåŠ¨é¡µé¢
            window.addEventListener('keydown', function(e) {
                if(e.keyCode === 32 && e.target === document.body) {
                    e.preventDefault();
                }
            });
            
            // åˆå§‹åŒ–æ’­æ”¾éšæœºstayè§†é¢‘
            initStayVideo();
            
            // ==================== æŠ½å¥–é€»è¾‘ ====================
            
            // è·å–æŠ½å¥–ç›¸å…³å…ƒç´ 
            const lotteryButton = document.getElementById('lotteryButton');
            const lotteryModal = document.getElementById('lotteryModal');
            const closeLottery = document.getElementById('closeLottery');
            const spinButton = document.getElementById('spinButton');
            const lotteryWheel = document.getElementById('lotteryWheel');
            const lotteryResult = document.getElementById('lotteryResult');
            const confirmResult = document.getElementById('confirmResult');
            
            // å¥–å“åº“å­˜å…ƒç´ 
            const keychainCount = document.getElementById('keychainCount');
            const mousepadCount = document.getElementById('mousepadCount');
            const cupCount = document.getElementById('cupCount');
            
            // å¥–å“åº“å­˜
            let prizes = {
                keychain: 98,
                mousepad: 46,
                cup: 1,
                candy: Infinity // ä¸é™é‡
            };
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åº“å­˜
            function loadPrizesFromStorage() {
                const savedPrizes = localStorage.getItem('lotteryPrizes');
                if (savedPrizes) {
                    const parsed = JSON.parse(savedPrizes);
                    prizes.keychain = parsed.keychain || 98;
                    prizes.mousepad = parsed.mousepad || 46;
                    prizes.cup = parsed.cup || 1;
                    updatePrizeDisplay();
                }
            }
            
            // ä¿å­˜åº“å­˜åˆ°æœ¬åœ°å­˜å‚¨
            function savePrizesToStorage() {
                localStorage.setItem('lotteryPrizes', JSON.stringify({
                    keychain: prizes.keychain,
                    mousepad: prizes.mousepad,
                    cup: prizes.cup
                }));
            }
            
            // æ›´æ–°å¥–å“æ˜¾ç¤º
            function updatePrizeDisplay() {
                keychainCount.textContent = prizes.keychain;
                mousepadCount.textContent = prizes.mousepad;
                cupCount.textContent = prizes.cup;
                
                // å¦‚æœæŸä¸ªå¥–å“åº“å­˜ä¸º0ï¼Œç¦ç”¨å¯¹åº”çš„è½¬ç›˜åŒºåŸŸ
                document.querySelectorAll('.prize-item').forEach(item => {
                    const prizeType = item.dataset.prize;
                    if (prizes[prizeType] === 0) {
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    }
                });
            }
            
            // æ‰“å¼€æŠ½å¥–æ¨¡æ€æ¡†
            lotteryButton.addEventListener('click', function() {
                loadPrizesFromStorage();
                lotteryModal.style.display = 'flex';
            });
            
            // å…³é—­æŠ½å¥–æ¨¡æ€æ¡†
            closeLottery.addEventListener('click', function() {
                lotteryModal.style.display = 'none';
                resetLottery();
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            lotteryModal.addEventListener('click', function(e) {
                if (e.target === lotteryModal) {
                    lotteryModal.style.display = 'none';
                    resetLottery();
                }
            });
            
            // æŠ½å¥–é€»è¾‘
            let isSpinning = false;
            
            spinButton.addEventListener('click', function() {
                if (isSpinning) return;
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¥–å“
                const availablePrizes = Object.keys(prizes).filter(prize => 
                    prize === 'candy' || prizes[prize] > 0
                );
                
                if (availablePrizes.length === 0) {
                    lotteryResult.textContent = 'æ‰€æœ‰å¥–å“å·²æŠ½å®Œï¼';
                    return;
                }
                
                isSpinning = true;
                lotteryResult.textContent = 'æŠ½å¥–ä¸­...';
                lotteryResult.className = 'lottery-result';
                confirmResult.style.display = 'none';
                
                // è®¡ç®—æ¦‚ç‡åˆ†å¸ƒ
                const probabilities = calculateProbabilities();
                
                // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©å¥–å“
                const selectedPrize = selectPrizeByProbability(probabilities);
                
                // è®¡ç®—è½¬ç›˜åœæ­¢çš„è§’åº¦ï¼ˆç¡®ä¿åœåœ¨é€‰ä¸­å¥–å“çš„ä½ç½®ï¼‰
                const prizeAngles = {
                    keychain: [22.5, 202.5, 337.5], // é’¥åŒ™æ‰£åœ¨è½¬ç›˜ä¸Šçš„è§’åº¦
                    mousepad: [67.5, 247.5],        // é¼ æ ‡å«åœ¨è½¬ç›˜ä¸Šçš„è§’åº¦
                    cup: [112.5],                   // æ°´æ¯åœ¨è½¬ç›˜ä¸Šçš„è§’åº¦
                    candy: [157.5, 292.5]           // ç³–æœåœ¨è½¬ç›˜ä¸Šçš„è§’åº¦
                };
                
                const targetAngle = prizeAngles[selectedPrize][0]; // å–ç¬¬ä¸€ä¸ªå‡ºç°çš„ä½ç½®
                const fullRotations = 5; // å®Œæ•´æ—‹è½¬åœˆæ•°
                const finalRotation = fullRotations * 360 + (360 - targetAngle);
                
                // æ‰§è¡Œè½¬ç›˜åŠ¨ç”»
                lotteryWheel.style.transform = `rotate(${finalRotation}deg)`;
                
                // åŠ¨ç”»ç»“æŸåæ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    isSpinning = false;
                    displayLotteryResult(selectedPrize);
                }, 4000);
            });
            
            // è®¡ç®—æ¦‚ç‡åˆ†å¸ƒ
            function calculateProbabilities() {
                const totalRemaining = prizes.keychain + prizes.mousepad + prizes.cup;
                
                // å¦‚æœé™é‡å¥–å“éƒ½æŠ½å®Œäº†ï¼Œ100%æ¦‚ç‡æ˜¯ç³–æœ
                if (totalRemaining === 0) {
                    return { candy: 1 };
                }
                
                // åŸºç¡€æ¦‚ç‡åˆ†å¸ƒ
                const probabilities = {
                    keychain: prizes.keychain / totalRemaining * 0.7, // 70%çš„æ¦‚ç‡åˆ†é…ç»™é™é‡å¥–å“
                    mousepad: prizes.mousepad / totalRemaining * 0.7,
                    cup: prizes.cup / totalRemaining * 0.7,
                    candy: 0.3 // 30%çš„æ¦‚ç‡æ˜¯ç³–æœ
                };
                
                // è°ƒæ•´æ°´æ¯æ¦‚ç‡ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ªï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
                if (prizes.cup > 0) {
                    // å¢åŠ æ°´æ¯çš„æ¦‚ç‡ï¼Œä½¿å…¶æ›´å®¹æ˜“è¢«æŠ½ä¸­ï¼ˆä½†ä¸è¶…è¿‡20%ï¼‰
                    const cupBonus = Math.min(0.2, 0.7 / totalRemaining);
                    probabilities.cup += cupBonus;
                    
                    // ä»å…¶ä»–å¥–å“ä¸­å‡å»å¢åŠ çš„æ¦‚ç‡
                    const reduction = cupBonus / 2;
                    probabilities.keychain = Math.max(0, probabilities.keychain - reduction);
                    probabilities.mousepad = Math.max(0, probabilities.mousepad - reduction);
                }
                
                return probabilities;
            }
            
            // æ ¹æ®æ¦‚ç‡é€‰æ‹©å¥–å“
            function selectPrizeByProbability(probabilities) {
                const random = Math.random();
                let cumulative = 0;
                
                for (const [prize, probability] of Object.entries(probabilities)) {
                    cumulative += probability;
                    if (random <= cumulative) {
                        return prize;
                    }
                }
                
                // é»˜è®¤è¿”å›ç³–æœï¼ˆç†è®ºä¸Šä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼‰
                return 'candy';
            }
            
            // æ˜¾ç¤ºæŠ½å¥–ç»“æœ
            function displayLotteryResult(prize) {
                const prizeNames = {
                    keychain: 'ğŸ‰ æ­å–œæ‚¨è·å¾—ã€å®šåˆ¶é’¥åŒ™æ‰£ã€‘ä¸€ä¸ªï¼',
                    mousepad: 'ğŸ‰ æ­å–œæ‚¨è·å¾—ã€ç²¾ç¾é¼ æ ‡å«ã€‘ä¸€ä¸ªï¼',
                    cup: 'ğŸŠ è¶…çº§å¤§å¥–ï¼æ­å–œæ‚¨è·å¾—ã€é™é‡æ°´æ¯ã€‘ä¸€ä¸ªï¼',
                    candy: 'ğŸ‰ æ­å–œæ‚¨è·å¾—ã€é¥¼å¹²ç³–æœã€‘ä¸€ä»½ï¼'
                };
                
                const prizeIcons = {
                    keychain: 'ğŸ”‘',
                    mousepad: 'ğŸ–±ï¸',
                    cup: 'ğŸ†',
                    candy: 'ğŸ¬'
                };
                
                lotteryResult.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 2rem;">${prizeIcons[prize]}</span>
                        <span>${prizeNames[prize]}</span>
                    </div>
                `;
                lotteryResult.className = 'lottery-result win';
                
                // å¦‚æœä¸æ˜¯ç³–æœï¼Œå‡å°‘åº“å­˜
                if (prize !== 'candy' && prizes[prize] > 0) {
                    prizes[prize]--;
                    updatePrizeDisplay();
                    savePrizesToStorage();
                }
                
                // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                confirmResult.style.display = 'block';
                confirmResult.onclick = function() {
                    lotteryModal.style.display = 'none';
                    resetLottery();
                    alert('è¯·å‰å¾€æ‹›æ–°å¤„é¢†å–æ‚¨çš„å¥–å“ï¼');
                };
            }
            
            // é‡ç½®æŠ½å¥–çŠ¶æ€
            function resetLottery() {
                lotteryWheel.style.transform = 'rotate(0deg)';
                lotteryResult.textContent = '';
                lotteryResult.className = 'lottery-result';
                confirmResult.style.display = 'none';
                isSpinning = false;
            }
            
            // åˆå§‹åŒ–å¥–å“æ˜¾ç¤º
            updatePrizeDisplay();
        });
    </script>
</body>
</html>